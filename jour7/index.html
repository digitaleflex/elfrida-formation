<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord des Projets</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-lg">
        <div class="container mx-auto px-6 py-3">
            <div class="flex items-center justify-between">
                <div class="text-xl font-semibold">
                    <i class="fas fa-project-diagram"></i> Gestion de Projets
                </div>
                <div class="flex space-x-4">
                    <button class="bg-blue-500 text-white px-4 py-2 rounded-lg">
                        <i class="fas fa-plus"></i> Nouveau Projet
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-6">
        <!-- Filtres -->
        <div class="bg-white p-4 rounded-lg shadow mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Période</label>
                    <div class="flex space-x-2">
                        <input type="date" id="startDate" class="border rounded p-2 w-full">
                        <input type="date" id="endDate" class="border rounded p-2 w-full">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Catégorie</label>
                    <select id="categoryFilter" class="border rounded p-2 w-full">
                        <option value="">Toutes</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Statut</label>
                    <select id="statusFilter" class="border rounded p-2 w-full">
                        <option value="">Tous</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Priorité</label>
                    <select id="priorityFilter" class="border rounded p-2 w-full">
                        <option value="">Toutes</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- KPIs -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Projets Totaux</h3>
                <p id="totalProjects" class="text-2xl font-bold">0</p>
                <div class="text-green-500 text-sm">
                    <i class="fas fa-arrow-up"></i> +5% ce mois
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Budget Total</h3>
                <p id="totalBudget" class="text-2xl font-bold">0 F CFA</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Progression Moyenne</h3>
                <p id="avgProgress" class="text-2xl font-bold">0%</p>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-gray-500 text-sm">Projets En Cours</h3>
                <p id="activeProjects" class="text-2xl font-bold">0</p>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Répartition par Statut</h3>
                <div class="h-48">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-4 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4">Progression par Catégorie</h3>
                <div class="h-48">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Liste des Projets -->
        <div class="bg-white rounded-lg shadow">
            <div class="p-4 border-b">
                <h3 class="text-lg font-semibold">Projets Récents</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Projet</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Catégorie</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Progression</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projectsList" class="bg-white divide-y divide-gray-200">
                        <!-- Les projets seront insérés ici dynamiquement -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Configuration des graphiques
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        boxWidth: 15
                    }
                }
            },
            animation: {
                duration: 1000
            }
        };

        // Initialisation des graphiques
        let statusChart, categoryChart;

        // Fonction pour formater les nombres en CFA
        const formatCFA = (number) => new Intl.NumberFormat('fr-FR', { 
            style: 'currency', 
            currency: 'XOF',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(number).replace('XOF', 'F CFA');

        // Fonction pour mettre à jour les KPIs
        function updateKPIs(data) {
            const totalProjects = data.length;
            const budgetTotal = data.reduce((sum, project) => sum + parseFloat(project.budget || 0), 0);
            const avgProgress = data.reduce((sum, project) => sum + parseInt(project.progression || 0), 0) / totalProjects;
            const activeProjects = data.filter(project => project.statut === 'en cours').length;

            document.getElementById('totalProjects').textContent = totalProjects;
            document.getElementById('totalBudget').textContent = formatCFA(budgetTotal);
            document.getElementById('avgProgress').textContent = `${Math.round(avgProgress)}%`;
            document.getElementById('activeProjects').textContent = activeProjects;
        }

        // Fonction pour mettre à jour les graphiques
        function updateCharts(data) {
            // Données pour le graphique des statuts
            const statusData = {
                labels: ['En cours', 'Terminé', 'Annulé'],
                datasets: [{
                    data: [
                        data.filter(p => p.statut === 'en cours').length,
                        data.filter(p => p.statut === 'terminé').length,
                        data.filter(p => p.statut === 'annulé').length
                    ],
                    backgroundColor: ['#3498db', '#2ecc71', '#e74c3c'],
                    borderWidth: 0
                }]
            };

            // Données pour le graphique des catégories
            const categories = [...new Set(data.map(p => p.categorie_nom))];
            const categoryData = {
                labels: categories,
                datasets: [{
                    label: 'Progression moyenne (%)',
                    data: categories.map(cat => {
                        const projetsCategorie = data.filter(p => p.categorie_nom === cat);
                        return Math.round(projetsCategorie.reduce((sum, p) => sum + p.progression, 0) / projetsCategorie.length);
                    }),
                    backgroundColor: categories.map(cat => 
                        data.find(p => p.categorie_nom === cat)?.couleur || '#3498db'
                    ),
                    borderWidth: 0
                }]
            };

            // Mise à jour des graphiques
            if (statusChart) statusChart.destroy();
            if (categoryChart) categoryChart.destroy();

            statusChart = new Chart(
                document.getElementById('statusChart').getContext('2d'),
                {
                    type: 'doughnut',
                    data: statusData,
                    options: {
                        ...chartOptions,
                        cutout: '70%',
                        plugins: {
                            ...chartOptions.plugins,
                            legend: {
                                position: 'bottom',
                                labels: {
                                    padding: 10,
                                    usePointStyle: true,
                                    boxWidth: 8,
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        }
                    }
                }
            );

            categoryChart = new Chart(
                document.getElementById('categoryChart').getContext('2d'),
                {
                    type: 'bar',
                    data: categoryData,
                    options: {
                        ...chartOptions,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                ticks: {
                                    callback: value => `${value}%`,
                                    font: {
                                        size: 11
                                    }
                                }
                            },
                            x: {
                                ticks: {
                                    font: {
                                        size: 11
                                    }
                                }
                            }
                        },
                        plugins: {
                            ...chartOptions.plugins,
                            legend: {
                                display: false
                            }
                        },
                        barThickness: 20
                    }
                }
            );
        }

        // Fonction pour mettre à jour la liste des projets
        function updateProjectsList(data) {
            const tbody = document.getElementById('projectsList');
            tbody.innerHTML = '';

            data.forEach(project => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <div>
                                <div class="font-medium text-gray-900">${project.nom_projet}</div>
                                <div class="text-sm text-gray-500">${project.description || ''}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs" 
                              style="background-color: ${project.couleur}20; color: ${project.couleur}">
                            ${project.categorie_nom}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${project.progression}%"></div>
                        </div>
                        <span class="text-sm text-gray-500">${project.progression}%</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded-full text-xs ${
                            project.statut === 'en cours' ? 'bg-blue-100 text-blue-800' :
                            project.statut === 'terminé' ? 'bg-green-100 text-green-800' :
                            'bg-red-100 text-red-800'
                        }">
                            ${project.statut}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <button class="text-blue-600 hover:text-blue-900">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="text-red-600 hover:text-red-900 ml-3">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Fonction pour charger et mettre à jour toutes les données
        function loadData() {
            fetch('load.php')
                .then(response => response.json())
                .then(data => {
                    updateKPIs(data);
                    updateCharts(data);
                    updateProjectsList(data);
                })
                .catch(error => console.error('Erreur:', error));
        }

        // Initialisation des filtres
        function initializeFilters(data) {
            const categories = [...new Set(data.map(p => p.categorie_nom))];
            const statuts = ['en cours', 'terminé', 'annulé'];
            const priorites = ['basse', 'moyenne', 'haute'];

            const categorySelect = document.getElementById('categoryFilter');
            const statusSelect = document.getElementById('statusFilter');
            const prioritySelect = document.getElementById('priorityFilter');

            categories.forEach(cat => {
                categorySelect.add(new Option(cat, cat));
            });

            statuts.forEach(statut => {
                statusSelect.add(new Option(statut, statut));
            });

            priorites.forEach(priorite => {
                prioritySelect.add(new Option(priorite, priorite));
            });
        }

        // Événements des filtres
        document.querySelectorAll('select, input[type="date"]').forEach(element => {
            element.addEventListener('change', () => {
                const filters = {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    category: document.getElementById('categoryFilter').value,
                    status: document.getElementById('statusFilter').value,
                    priority: document.getElementById('priorityFilter').value
                };

                // Appliquer les filtres et mettre à jour l'interface
                fetch(`load.php?${new URLSearchParams(filters)}`)
                    .then(response => response.json())
                    .then(data => {
                        updateKPIs(data);
                        updateCharts(data);
                        updateProjectsList(data);
                    });
            });
        });

        // Chargement initial des données
        loadData();
    </script>
</body>

</html>